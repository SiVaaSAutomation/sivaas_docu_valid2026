---
- hosts: my_servers
  become: true
  become_method: runas
  become_user: Administrator
  gather_facts: no

  tasks:
    - block:
        - name: Reboot
          ansible.windows.win_reboot:
            reboot_timeout: 600

      rescue:
        - ansible.builtin.debug:
            msg: "Playbook failed â€“ exporting Semaphore UI log anyway."

      always:
        - name: Export Semaphore UI log via bash script (runs on Semaphore VM)
          delegate_to: localhost
          run_once: true
          become: false
          vars:
            ansible_connection: local
          ansible.builtin.shell: |
            set -euo pipefail

            # Export-Script liegt im Repo
            bash tools/export_tasklog.sh "{{ semaphore_vars.task_details.id }}"
          args:
            executable: /bin/bash
